name: awepep-agent

on:
  workflow_dispatch:
    inputs:
      doi_or_url:
        description: DOI, DOI URL, or arXiv URL
        required: true
        type: string
  issue_comment:
    types: [created]

jobs:
  add-paper:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       startsWith(github.event.comment.body, '/awe add') &&
       (github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install
        run: |
          python -m pip install -U pip
          python -m pip install -e .[agent]

      - name: Resolve input
        id: input
        env:
          BODY: ${{ github.event.comment.body }}
          INPUT: ${{ inputs.doi_or_url }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          python - <<'PY'
          import os, re

          event = os.environ.get("EVENT_NAME", "")
          if event == "workflow_dispatch":
            arg = (os.environ.get("INPUT") or "").strip()
          else:
            body = os.environ.get("BODY") or ""
            first = (body.strip().splitlines() or [""])[0].strip()
            m = re.match(r"^/awe add\s+(.+)$", first)
            arg = m.group(1).strip() if m else ""

          if not arg:
            raise SystemExit("Could not parse doi_or_url input.")

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"doi_or_url={arg}\n")
          PY

      - name: Run agent
        env:
          AWEPEP_LLM_BASE_URL: ${{ secrets.AWEPEP_LLM_BASE_URL }}
          AWEPEP_LLM_API_KEY: ${{ secrets.AWEPEP_LLM_API_KEY }}
          AWEPEP_LLM_MODEL: ${{ secrets.AWEPEP_LLM_MODEL }}
        run: |
          awe-agent add \
            --non-interactive \
            --doi-or-url "${{ steps.input.outputs.doi_or_url }}" \
            --write-csv \
            --write-readme \
            --emit-notes \
            --emit-json \
            --emit-pr-body

      - name: Read run metadata
        id: meta
        run: |
          python - <<'PY'
          import glob, json, os

          runs = glob.glob("out/*/run.json")
          if not runs:
            raise SystemExit("No out/*/run.json produced.")
          runs.sort(key=lambda p: os.path.getmtime(p), reverse=True)
          run_path = runs[0]
          run = json.load(open(run_path, encoding="utf-8"))

          slug = run["doi_slug"]
          title = (run.get("title") or "").strip()
          body_path = (run.get("pr_body_path") or "").strip()
          branch = f"awepep-agent/{slug}"
          pr_title = "Add paper: " + (title[:120] if title else slug)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"slug={slug}\n")
            f.write(f"branch={branch}\n")
            f.write(f"pr_title={pr_title}\n")
            f.write(f"pr_body_path={body_path}\n")
          PY

      - name: Create draft PR
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.meta.outputs.branch }}
          delete-branch: true
          title: ${{ steps.meta.outputs.pr_title }}
          body-path: ${{ steps.meta.outputs.pr_body_path }}
          commit-message: ${{ steps.meta.outputs.pr_title }}
          draft: true
          add-paths: |
            data/paper.csv
            README.md

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: awepep-agent-${{ steps.meta.outputs.slug }}
          path: out/${{ steps.meta.outputs.slug }}

      - name: Comment back
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = `${{ steps.cpr.outputs.pull-request-url }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `Draft PR created: ${prUrl}`
            });

